<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>FST Fantasy ‚öΩ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00c3ff;
      --accent: #4ecdc4;
      --bg: #0f1923;
      --card-bg: #1a2a3a;
      --text: #ffffff;
      --text-secondary: #a0b3c6;
      --success: #4ade80;
      --border: #2c3e50;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      font-size: 15px;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      padding: 16px 0 12px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      color: var(--primary);
      margin: 0;
      font-weight: 700;
      font-size: 22px;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .section {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .profile-pic {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--primary);
    }

    .profile-info h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 4px;
    }

    .profile-stats {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      gap: 12px;
    }

    button {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    #connectWallet {
      background: var(--primary);
      color: #000;
    }

    #connectWallet:hover {
      background: #00a8e8;
    }

    #joinContest {
      background: var(--accent);
      color: #000;
    }

    #joinContest:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #loadPlayers {
      background: #556ee6;
      color: white;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    input, select {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(26, 42, 58, 0.7);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      flex: 1;
      min-width: 120px;
    }

    .filter-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .filter-btn {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary);
      color: #000;
    }

    .player-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      margin-top: 12px;
    }

    .player-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .player-card.selected {
      background: rgba(0, 195, 255, 0.15);
      border-color: var(--primary);
    }

    .player-photo {
      width: 64px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      background: #000;
      margin-bottom: 10px;
    }

    .player-name {
      font-weight: 600;
      text-align: center;
      font-size: 14px;
      margin: 4px 0;
    }

    .player-meta {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: 12px;
      margin-top: 4px;
    }

    .price-tag {
      color: var(--accent);
      font-weight: 600;
    }

    .points-tag {
      color: gold;
      font-weight: 600;
    }

    .team-display {
      min-height: 100px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .team-player {
      background: rgba(0, 195, 255, 0.1);
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 13px;
    }

    #status {
      text-align: center;
      margin: 12px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .lb-rank {
      width: 28px;
      height: 28px;
      background: var(--primary);
      color: #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      margin-right: 10px;
    }

    .lb-info {
      flex: 1;
    }

    .lb-name {
      font-weight: 600;
      font-size: 14px;
    }

    .lb-points {
      color: gold;
      font-weight: 600;
      font-size: 13px;
    }

    .lb-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 10px;
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 10px 0;
      position: sticky;
      bottom: 0;
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 10px;
      padding: 4px 0;
      cursor: pointer;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 18px;
      margin-bottom: 2px;
    }
  </style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="header">
    <h1>‚öΩ FST Fantasy</h1>
  </div>

  <div class="main-content">
    <!-- HOME VIEW -->
    <div id="homeView" class="view active">
      <div id="status">Tap 'Connect Wallet' to begin</div>

      <div class="section" id="profileSection" style="display:none;">
        <div class="profile-header">
          <img id="userProfilePic" src="https://via.placeholder.com/56x56?text=üë§" class="profile-pic" alt="Profile">
          <div class="profile-info">
            <h2 id="userDisplayName">FST Manager</h2>
            <div class="profile-stats">
              <span>Entries: <strong id="userEntries">0</strong></span>
              <span>Points: <strong id="userPoints">0</strong></span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <button id="connectWallet">üîê Connect Wallet</button>
        <div style="text-align: center; color: var(--success); font-weight: 500;">
          ‚úÖ Entry is <strong>FREE</strong> this week!
        </div>
        <div style="text-align: center; color: var(--text-secondary); margin-top: 6px;">
          Prize Pool: <strong id="prizeAmount">0 FST</strong> (<span id="entries">0</span> managers)
        </div>
      </div>

      <div class="section">
        <h3 style="margin: 0 0 14px; font-weight: 600;">Select Your 11</h3>
        
        <div class="controls">
          <input type="text" id="searchInput" placeholder="üîç Search player or team...">
          <select id="sortSelect">
            <option value="name">Name</option>
            <option value="cost">Cost</option>
            <option value="points">Points</option>
          </select>
        </div>

        <div class="filter-group">
          <button class="filter-btn active" data-pos="all">All</button>
          <button class="filter-btn" data-pos="1">GK</button>
          <button class="filter-btn" data-pos="2">DEF</button>
          <button class="filter-btn" data-pos="3">MID</button>
          <button class="filter-btn" data-pos="4">FWD</button>
        </div>

        <button id="loadPlayers">üì• Load EPL Players</button>
        <div class="player-grid" id="playerGrid"></div>
      </div>
    </div>

    <!-- TEAM VIEW -->
    <div id="teamView" class="view">
      <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; font-weight: 600;">‚úÖ Your Team</h3>
          <span id="teamCount" style="background: var(--primary); color: #000; padding: 2px 8px; border-radius: 20px; font-weight: 600;">
            0/11
          </span>
        </div>
        <div class="team-display" id="teamContainer"></div>
        <button id="joinContest" disabled>üéØ Join Contest</button>
      </div>
    </div>

    <!-- LEADERBOARD VIEW -->
    <div id="leaderboardView" class="view">
      <div class="section">
        <h3 style="margin: 0 0 14px; font-weight: 600;">üèÜ Leaderboard</h3>
        <div id="leaderboard"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAVIGATION -->
  <div class="bottom-nav">
    <button class="nav-item active" data-view="home">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </button>
    <button class="nav-item" data-view="team">
      <i class="fas fa-users"></i>
      <span>Team</span>
    </button>
    <button class="nav-item" data-view="leaderboard">
      <i class="fas fa-trophy"></i>
      <span>Top</span>
    </button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // Get Telegram user data
    const initData = tg.initDataUnsafe;
    const telegramUser = initData?.user;
    const userId = telegramUser ? telegramUser.id.toString() : 'user_' + Math.random().toString(36).substr(2, 9);

    let selectedPlayers = [];
    const MAX_PLAYERS = 11;

    // DOM Elements
    const connectWalletBtn = document.getElementById('connectWallet');
    const loadPlayersBtn = document.getElementById('loadPlayers');
    const joinContestBtn = document.getElementById('joinContest');
    const playerGrid = document.getElementById('playerGrid');
    const teamContainer = document.getElementById('teamContainer');
    const teamCount = document.getElementById('teamCount');
    const statusDiv = document.getElementById('status');
    const prizeAmountSpan = document.getElementById('prizeAmount');
    const entriesSpan = document.getElementById('entries');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const filterButtons = document.querySelectorAll('.filter-btn');

    // Profile elements
    const profileSection = document.getElementById('profileSection');
    const userProfilePic = document.getElementById('userProfilePic');
    const userDisplayName = document.getElementById('userDisplayName');
    const userEntries = document.getElementById('userEntries');
    const userPoints = document.getElementById('userPoints');

    let allPlayers = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let currentSort = 'name';

    // Navigation
    const navItems = document.querySelectorAll('.nav-item');
    const views = {
      home: document.getElementById('homeView'),
      team: document.getElementById('teamView'),
      leaderboard: document.getElementById('leaderboardView')
    };

    // Switch view
    function switchView(viewName) {
      Object.keys(views).forEach(key => {
        views[key].classList.remove('active');
      });
      views[viewName].classList.add('active');
      
      navItems.forEach(item => {
        if (item.dataset.view === viewName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      // Load leaderboard when switching to it
      if (viewName === 'leaderboard') {
        loadLeaderboard();
      }
    }

    // Nav click handlers
    navItems.forEach(item => {
      item.addEventListener('click', () => {
        switchView(item.dataset.view);
      });
    });

    // Connect Wallet
    connectWalletBtn.addEventListener('click', async () => {
      statusDiv.innerText = "Connecting...";
      try {
        const response = await fetch('/connect-wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            displayName: telegramUser?.first_name || "FST Manager",
            profilePic: telegramUser?.photo_url || null
          })
        });
        const data = await response.json();
        if (data.address) {
          statusDiv.innerText = `‚úÖ Welcome, ${data.displayName}!`;
          connectWalletBtn.style.display = 'none';
          
          profileSection.style.display = 'block';
          userProfilePic.src = data.profilePic;
          userDisplayName.innerText = data.displayName;
          
          updatePrizePool();
          loadUserProfile();
        } else {
          throw new Error('Connection failed');
        }
      } catch (e) {
        statusDiv.innerText = "‚ùå Connection failed";
        alert("Try again.");
      }
    });

    // Load Players
    loadPlayersBtn.addEventListener('click', async () => {
      statusDiv.innerText = "Loading players...";
      loadPlayersBtn.disabled = true;
      try {
        const response = await fetch('/players');
        const players = await response.json();
        renderPlayers(players);
        statusDiv.innerText = "Select 11 players";
        loadPlayersBtn.style.display = 'none';
      } catch (e) {
        statusDiv.innerText = "‚ùå Failed to load";
        loadPlayersBtn.disabled = false;
      }
    });

    // Render Players
    function renderPlayers(players) {
      allPlayers = players;
      renderFilteredPlayers();
    }

    function renderFilteredPlayers() {
      let filtered = allPlayers.filter(player => {
        const matchesSearch = 
          player.web_name.toLowerCase().includes(currentSearch) ||
          player.team_name.toLowerCase().includes(currentSearch);
        const matchesFilter = 
          currentFilter === 'all' || 
          player.element_type == parseInt(currentFilter);
        return matchesSearch && matchesFilter;
      });

      filtered.sort((a, b) => {
        if (currentSort === 'cost') return parseFloat(b.now_cost) - parseFloat(a.now_cost);
        if (currentSort === 'points') return b.total_points - a.total_points;
        return a.web_name.localeCompare(b.web_name);
      });

      playerGrid.innerHTML = '';
      filtered.forEach(player => {
        const isSelected = selectedPlayers.some(p => p.id === player.id);
        const card = document.createElement('div');
        card.className = `player-card ${isSelected ? 'selected' : ''}`;
        card.innerHTML = `
          <img src="${player.photo_url}" class="player-photo" onerror="this.src='https://via.placeholder.com/64x80?text=‚ùì'">
          <div class="player-name">${player.web_name}</div>
          <div class="player-meta">
            <span>${player.position} ‚Ä¢ ${player.team_name}</span>
            <span class="price-tag">¬£${player.now_cost}m</span>
          </div>
          <div class="player-meta">
            <span></span>
            <span class="points-tag">${player.total_points} pts</span>
          </div>
        `;

        card.addEventListener('click', () => {
          togglePlayerSelection(player);
          updateTeamDisplay();
          checkJoinButton();
        });

        playerGrid.appendChild(card);
      });
    }

    function togglePlayerSelection(player) {
      const index = selectedPlayers.findIndex(p => p.id === player.id);
      if (index > -1) {
        selectedPlayers.splice(index, 1);
      } else if (selectedPlayers.length < MAX_PLAYERS) {
        selectedPlayers.push(player);
      }
      renderFilteredPlayers();
      updateTeamDisplay();
      checkJoinButton();
    }

    function updateTeamDisplay() {
      teamContainer.innerHTML = '';
      selectedPlayers.forEach(player => {
        const span = document.createElement('span');
        span.className = 'team-player';
        span.innerText = `${player.web_name} (${player.position})`;
        teamContainer.appendChild(span);
      });
      teamCount.innerText = `${selectedPlayers.length}/${MAX_PLAYERS}`;
    }

    function checkJoinButton() {
      joinContestBtn.disabled = selectedPlayers.length !== MAX_PLAYERS;
    }

    // Join Contest
    joinContestBtn.addEventListener('click', async () => {
      statusDiv.innerText = "Joining...";
      joinContestBtn.disabled = true;

      try {
        const response = await fetch('/save-team', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, team: selectedPlayers.map(p => p.id) })
        });

        const data = await response.json();
        if (data.success) {
          statusDiv.innerText = "üéâ Entered! Good luck!";
          joinContestBtn.innerText = "‚úÖ Entered!";
          updatePrizePool();
          loadLeaderboard();
          loadUserProfile();
          // Switch to leaderboard to show result
          switchView('leaderboard');
        } else {
          throw new Error('Failed');
        }
      } catch (e) {
        statusDiv.innerText = "‚ùå Failed to join";
        joinContestBtn.disabled = false;
      }
    });

    // Load User Profile
    async function loadUserProfile() {
      try {
        const response = await fetch(`/user-profile?userId=${userId}`);
        const profile = await response.json();
        
        userDisplayName.innerText = profile.displayName;
        userProfilePic.src = profile.profilePic;
        userEntries.innerText = profile.entries;
        userPoints.innerText = profile.points;
        
        selectedPlayers = profile.team || [];
        updateTeamDisplay();
        checkJoinButton();
      } catch (e) {
        console.log("Profile load failed");
      }
    }

    // Update Prize Pool
    async function updatePrizePool() {
      try {
        const response = await fetch('/prize-pool');
        const data = await response.json();
        prizeAmountSpan.innerText = `${data.fst} FST`;
        entriesSpan.innerText = data.entries;
      } catch (e) {
        console.log("Prize pool failed");
      }
    }

    // Load Leaderboard
    async function loadLeaderboard() {
      try {
        const response = await fetch('/leaderboard');
        const data = await response.json();
        const lbDiv = document.getElementById('leaderboard');
        lbDiv.innerHTML = '';
        data.forEach((entry, i) => {
          const div = document.createElement('div');
          div.className = 'leaderboard-item';
          div.innerHTML = `
            <div class="lb-rank">${i+1}</div>
            <div class="lb-info">
              <div class="lb-name">${entry.displayName}</div>
              <div class="lb-points">${entry.points} pts</div>
            </div>
            <img src="${entry.profilePic}" class="lb-avatar" onerror="this.src='https://via.placeholder.com/32x32?text=üë§'">
          `;
          lbDiv.appendChild(div);
        });
      } catch (e) {
        console.log("Leaderboard failed");
      }
    }

    // Event Listeners
    searchInput.addEventListener('input', (e) => {
      currentSearch = e.target.value.toLowerCase();
      renderFilteredPlayers();
    });

    sortSelect.addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderFilteredPlayers();
    });

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.pos;
        renderFilteredPlayers();
      });
    });
  </script>
</body>
</html>
