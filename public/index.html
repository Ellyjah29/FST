<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>FST Fantasy ‚öΩ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f1923;
      color: white;
      margin: 0;
      padding: 16px 16px 80px 16px;
      font-size: 16px;
      position: relative;
    }
    h1 {
      text-align: center;
      color: #00c3ff;
      margin-bottom: 10px;
    }
    .section {
      background: #1a2a3a;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
    }
    button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    #connectWallet {
      background: #00c3ff;
      color: #000;
    }
    #joinContest {
      background: #4ecdc4;
      color: #000;
    }
    #loadPlayers {
      background: #556ee6;
      color: white;
    }
    .player-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    .player-card {
      background: #2a3a4a;
      padding: 12px;
      border-radius: 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .player-card.selected {
      background: #00c3ff;
      color: #000;
    }
    .player-photo {
      width: 60px;
      height: 75px;
      object-fit: cover;
      border-radius: 6px;
      background: #000;
      margin-bottom: 8px;
      border: 2px solid transparent;
    }
    .player-card.selected .player-photo {
      border-color: #000;
    }
    .team-logo {
      width: 24px;
      height: 24px;
      margin-bottom: 6px;
    }
    .player-name {
      font-weight: bold;
      text-align: center;
      margin: 4px 0;
      font-size: 14px;
    }
    .player-meta {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: 12px;
      color: #ccc;
      margin-top: 4px;
    }
    .price-tag {
      color: #4ecdc4;
      font-weight: bold;
    }
    .points-tag {
      color: gold;
      font-weight: bold;
    }
    #status {
      text-align: center;
      margin: 10px 0;
      font-size: 14px;
      color: #aaa;
    }
    #leaderboard {
      max-height: 200px;
      overflow-y: auto;
    }
    .leaderboard-item {
      padding: 8px;
      border-bottom: 1px solid #333;
    }
    input, select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #222;
      color: white;
      font-size: 14px;
    }
    .filter-btn {
      padding: 6px 12px;
      background: #333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .filter-btn.active {
      background: #00c3ff;
      color: #000;
    }

    /* Tab Bar */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background: #15202b;
      padding: 10px 0;
      border-top: 1px solid #333;
      z-index: 10000;
      pointer-events: auto;
    }
    .tab-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: none;
      border: none;
      color: #aaa;
      font-size: 10px;
      padding: 6px 4px;
      cursor: pointer;
      width: 100%;
      max-width: 60px;
      text-align: center;
      pointer-events: auto;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn.active {
      color: #00c3ff;
      text-shadow: 0 0 4px rgba(0, 195, 255, 0.7);
    }
    .tab-btn i {
      font-size: 18px;
      margin-bottom: 2px;
    }
    .tab-btn:active {
      transform: scale(0.95);
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>‚öΩ FST Fantasy</h1>

  <div id="status">Initializing...</div>

  <div class="section">
    <button id="connectWallet">üîê Connect Wallet</button>
    <div>‚úÖ Entry is <strong>FREE</strong> this week!</div>
    <div>Prize Pool: <strong id="prizeAmount">0 FST</strong> (<span id="entries">0</span> managers)</div>
  </div>

  <!-- ===== PLAYER SELECTION SECTION ===== -->
  <div class="section">
    <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
      <input type="text" id="searchInput" placeholder="üîç Search player or team..." style="flex: 1;">
      <select id="sortSelect">
        <option value="name">Sort by Name</option>
        <option value="cost">Sort by Cost</option>
        <option value="points">Sort by Points</option>
      </select>
    </div>

    <div style="display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap;">
      <button class="filter-btn active" data-pos="all">All</button>
      <button class="filter-btn" data-pos="1">GK</button>
      <button class="filter-btn" data-pos="2">DEF</button>
      <button class="filter-btn" data-pos="3">MID</button>
      <button class="filter-btn" data-pos="4">FWD</button>
    </div>

    <button id="loadPlayers">üì• Load EPL Players</button>
    <div class="player-grid" id="playerGrid"></div>
  </div>

  <div class="section">
    <h3>‚úÖ Your Team (0/11)</h3>
    <div id="teamContainer"></div>
    <button id="joinContest" disabled>üéØ Join Contest (Pick 11 First)</button>
  </div>

  <div class="section">
    <h3>üèÜ Leaderboard</h3>
    <div id="leaderboard"></div>
  </div>

  <!-- BOTTOM TAB BAR -->
  <div class="tab-bar" id="tabBar">
    <button class="tab-btn active" data-league="epl">
      <i class="fas fa-futbol"></i> EPL
    </button>
    <button class="tab-btn" data-league="seriea" disabled>
      <i class="fas fa-trophy"></i> Serie A
    </button>
    <button class="tab-btn" data-league="laliga" disabled>
      <i class="fas fa-futbol"></i> La Liga
    </button>
    <button class="tab-btn" data-league="bundesliga" disabled>
      <i class="fas fa-flag-checkered"></i> Bundesliga
    </button>
    <button class="tab-btn" data-league="wsl" disabled>
      <i class="fas fa-venus"></i> WSL
    </button>
    <button class="tab-btn" data-league="euro" disabled>
      <i class="fas fa-globe-europe"></i> Euro
    </button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    tg.onEvent('viewportChanged', () => {
      document.body.style.height = window.innerHeight + 'px';
    });

    const userId = 'user_' + Math.random().toString(36).substr(2, 9);
    let selectedPlayers = [];
    const MAX_PLAYERS = 11;

    // DOM Elements
    const connectWalletBtn = document.getElementById('connectWallet');
    const loadPlayersBtn = document.getElementById('loadPlayers');
    const joinContestBtn = document.getElementById('joinContest');
    const playerGrid = document.getElementById('playerGrid');
    const teamContainer = document.getElementById('teamContainer');
    const statusDiv = document.getElementById('status');
    const prizeAmountSpan = document.getElementById('prizeAmount');
    const entriesSpan = document.getElementById('entries');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const filterButtons = document.querySelectorAll('.filter-btn');

    let allPlayers = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let currentSort = 'name';

    statusDiv.innerText = "Tap 'Connect Wallet' to begin";

    // Connect Wallet
    connectWalletBtn.addEventListener('click', async () => {
      statusDiv.innerText = "Connecting wallet...";
      try {
        const response = await fetch('/connect-wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        if (data.address) {
          statusDiv.innerText = `‚úÖ Connected: ${data.address.slice(0, 6)}...${data.address.slice(-4)}`;
          connectWalletBtn.disabled = true;
          connectWalletBtn.innerText = "Wallet Connected";
          loadPlayersBtn.disabled = false;
          updatePrizePool();
        } else {
          throw new Error('Connection failed');
        }
      } catch (e) {
        statusDiv.innerText = "‚ùå Wallet connection failed";
        alert("Could not connect wallet. Try again.");
      }
    });

    // Load Players
    loadPlayersBtn.addEventListener('click', async () => {
      statusDiv.innerText = "Loading EPL players...";
      loadPlayersBtn.disabled = true;
      try {
        const response = await fetch('/players');
        const players = await response.json();
        renderPlayers(players);
        statusDiv.innerText = "Pick 11 players to join!";
      } catch (e) {
        statusDiv.innerText = "‚ùå Failed to load players";
        loadPlayersBtn.disabled = false;
      }
    });

    // Render Players (store all, then filter/sort)
    function renderPlayers(players) {
      allPlayers = players;
      renderFilteredPlayers();
    }

    // Filter & Sort & Render
    function renderFilteredPlayers() {
      let filtered = allPlayers.filter(player => {
        const matchesSearch = 
          player.web_name.toLowerCase().includes(currentSearch) ||
          player.team_name.toLowerCase().includes(currentSearch);
        const matchesFilter = 
          currentFilter === 'all' || 
          player.element_type == parseInt(currentFilter);
        return matchesSearch && matchesFilter;
      });

      // Sort
      filtered.sort((a, b) => {
        if (currentSort === 'cost') {
          return parseFloat(b.now_cost) - parseFloat(a.now_cost);
        } else if (currentSort === 'points') {
          return b.total_points - a.total_points;
        } else {
          return a.web_name.localeCompare(b.web_name);
        }
      });

      // Render
      playerGrid.innerHTML = '';
      filtered.forEach(player => {
        const isSelected = selectedPlayers.some(p => p.id === player.id);
        const card = document.createElement('div');
        card.className = `player-card ${isSelected ? 'selected' : ''}`;
        card.innerHTML = `
          <img src="${player.photo_url}" class="player-photo" onerror="this.src='https://via.placeholder.com/60x75?text=‚ùì'">
          <img src="${player.team_logo}" class="team-logo" onerror="this.style.display='none'">
          <div class="player-name">${player.web_name}</div>
          <div class="player-meta">
            <span>${player.position}</span>
            <span class="price-tag">¬£${player.now_cost}m</span>
          </div>
          <div class="player-meta">
            <span>${player.team_name}</span>
            <span class="points-tag">${player.total_points} pts</span>
          </div>
        `;

        card.addEventListener('click', () => {
          togglePlayerSelection(player);
          updateTeamDisplay();
          checkJoinButton();
        });

        playerGrid.appendChild(card);
      });
    }

    // Toggle player selection
    function togglePlayerSelection(player) {
      const index = selectedPlayers.findIndex(p => p.id === player.id);
      if (index > -1) {
        selectedPlayers.splice(index, 1);
      } else if (selectedPlayers.length < MAX_PLAYERS) {
        selectedPlayers.push(player);
      }
      renderFilteredPlayers(); // Re-render to update "selected" state
    }

    // Update team display
    function updateTeamDisplay() {
      teamContainer.innerHTML = '';
      selectedPlayers.forEach(player => {
        const div = document.createElement('div');
        div.innerText = `${player.web_name} (${player.position}) - ¬£${player.now_cost}m`;
        teamContainer.appendChild(div);
      });
      teamContainer.parentElement.querySelector('h3').innerText = `‚úÖ Your Team (${selectedPlayers.length}/11)`;
    }

    // Check join button
    function checkJoinButton() {
      joinContestBtn.disabled = selectedPlayers.length !== MAX_PLAYERS;
    }

    // Join Contest
    joinContestBtn.addEventListener('click', async () => {
      if (selectedPlayers.length !== MAX_PLAYERS) return;

      statusDiv.innerText = "Joining contest...";
      joinContestBtn.disabled = true;

      try {
        const response = await fetch('/save-team', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            team: selectedPlayers.map(p => p.id)
          })
        });

        const data = await response.json();
        if (data.success) {
          statusDiv.innerText = "üéâ Entered contest! Good luck!";
          joinContestBtn.innerText = "‚úÖ Entered!";
          joinContestBtn.disabled = true;
          loadPlayersBtn.style.display = 'none';
          updatePrizePool();
          loadLeaderboard();
        } else {
          throw new Error('Failed to join');
        }
      } catch (e) {
        statusDiv.innerText = "‚ùå Failed to join contest";
        joinContestBtn.disabled = false;
      }
    });

    // Update Prize Pool
    async function updatePrizePool() {
      try {
        const response = await fetch('/prize-pool');
        const data = await response.json();
        prizeAmountSpan.innerText = `${data.fst} FST`;
        entriesSpan.innerText = data.entries;
      } catch (e) {
        console.log("Could not fetch prize pool");
      }
    }

    // Load Leaderboard
    async function loadLeaderboard() {
      try {
        const response = await fetch('/leaderboard');
        const data = await response.json();
        const lbDiv = document.getElementById('leaderboard');
        lbDiv.innerHTML = '';
        data.forEach((entry, i) => {
          const div = document.createElement('div');
          div.className = 'leaderboard-item';
          div.innerHTML = `<strong>#${i+1}</strong> User: ${entry.userId} Points: ${entry.points}`;
          lbDiv.appendChild(div);
        });
      } catch (e) {
        console.log("Could not load leaderboard");
      }
    }

    // Search, Sort, Filter Events
    searchInput.addEventListener('input', (e) => {
      currentSearch = e.target.value.toLowerCase();
      renderFilteredPlayers();
    });

    sortSelect.addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderFilteredPlayers();
    });

    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.pos;
        renderFilteredPlayers();
      });
    });

    // Tab Bar
    document.addEventListener('DOMContentLoaded', function() {
      const tabBar = document.getElementById('tabBar');
      const tabButtons = tabBar.querySelectorAll('.tab-btn');

      tabButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();

          const league = this.dataset.league;
          tabButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          if (league !== 'epl') {
            if (tg.showPopup) {
              tg.showPopup({
                title: "üöß Coming Soon",
                message: `${league.toUpperCase()} league is under development.\nOnly EPL available for now!`,
                buttons: [{ type: "ok" }]
              });
            } else {
              alert(`${league.toUpperCase()} coming soon! Only EPL available.`);
            }
            return;
          }
        });
      });
    });
  </script>
</body>
</html>
