<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FST - Fantasy Sport Token</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-blue-600 text-white p-4 text-center text-2xl font-bold">
    FST - Fantasy Sport Token
</header>

<main class="p-4 max-w-6xl mx-auto">

<!-- Wallet Section -->
<section id="wallet" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Connect Wallet</h2>
    <button id="connectWallet" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        Connect Wallet
    </button>
    <p id="walletAddress" class="mt-2 text-sm"></p>
</section>

<!-- Players Section -->
<section id="players" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Top Players</h2>
    <div id="playersList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</section>

<!-- Live Scores Section -->
<section id="liveScores" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Live Scores</h2>
    <div id="liveScoresList" class="space-y-2"></div>
</section>

<!-- Transfers Graph -->
<section id="transfers" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Gameweek Transfers</h2>
    <canvas id="transfersChart" class="bg-white p-4 rounded shadow"></canvas>
</section>

<!-- League Table Section -->
<section id="league" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">League Table</h2>
    <div id="leagueTable" class="overflow-x-auto"></div>
</section>

</main>

<script>
    // Telegram Web App setup
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Web3 wallet connection (Metamask)
    const connectWalletBtn = document.getElementById('connectWallet');
    const walletAddressEl = document.getElementById('walletAddress');

    connectWalletBtn.addEventListener('click', async () => {
        if (window.ethereum) {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            walletAddressEl.textContent = `Connected: ${accounts[0]}`;
        } else {
            alert('Please install Metamask!');
        }
    });

    // FPL API base (CORS proxy recommended)
    const FPL_BASE = 'https://cors-anywhere.herokuapp.com/https://fantasy.premierleague.com/api';

    // Fetch top players
    async function fetchPlayers() {
        try {
            const res = await axios.get(`${FPL_BASE}/bootstrap-static/`);
            const players = res.data.elements.slice(0, 20); // top 20 for demo
            const container = document.getElementById('playersList');
            players.forEach(player => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded shadow hover:shadow-lg transition';
                card.innerHTML = `
                    <h3 class="font-semibold">${player.web_name}</h3>
                    <p>Team: ${res.data.teams.find(t => t.id === player.team).name}</p>
                    <p>Position: ${res.data.element_types.find(e => e.id === player.element_type).singular_name}</p>
                    <p>Price: Â£${player.now_cost / 10}</p>
                    <p>Points: ${player.total_points}</p>
                `;
                container.appendChild(card);
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Fetch live scores for current GW
    async function fetchLiveScores() {
        try {
            const eventsRes = await axios.get(`${FPL_BASE}/events/`);
            const currentGW = eventsRes.data.current;
            const liveRes = await axios.get(`${FPL_BASE}/event/${currentGW}/live/`);
            const container = document.getElementById('liveScoresList');
            liveRes.data.picks.slice(0, 10).forEach(pick => {
                const div = document.createElement('div');
                div.className = 'bg-white p-2 rounded shadow';
                div.textContent = `Player ID: ${pick.element}, Points: ${pick.stats.total_points}`;
                container.appendChild(div);
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Fetch transfers per GW and draw chart
    async function fetchTransfers() {
        try {
            const GW = 1; // Example: GW1
            const res = await axios.get(`${FPL_BASE}/game-week-transfers/${GW}/`);
            const ctx = document.getElementById('transfersChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(res.data).slice(0, 10),
                    datasets: [{
                        label: 'Transfers In',
                        data: Object.values(res.data).slice(0, 10).map(d => d.in),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    },{
                        label: 'Transfers Out',
                        data: Object.values(res.data).slice(0, 10).map(d => d.out),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        } catch (err) {
            console.error(err);
        }
    }

    // Fetch league table
    async function fetchLeague() {
        try {
            const LEAGUE_ID = 123456;
            const res = await axios.get(`${FPL_BASE}/leagues-classic/${LEAGUE_ID}/standings/`);
            const container = document.getElementById('leagueTable');
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <tr class="bg-gray-200">
                    <th class="p-2">Rank</th>
                    <th class="p-2">Manager</th>
                    <th class="p-2">Points</th>
                </tr>
            `;
            res.data.standings.results.slice(0, 10).forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${m.rank}</td>
                    <td class="p-2">${m.entry_name}</td>
                    <td class="p-2">${m.total}</td>
                `;
                table.appendChild(tr);
            });
            container.appendChild(table);
        } catch (err) {
            console.error(err);
        }
    }

    // Initialize dashboard
    fetchPlayers();
    fetchLiveScores();
    fetchTransfers();
    fetchLeague();
</script>

</body>
</html>
