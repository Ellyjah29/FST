<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FST - Fantasy Sport Token</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-blue-600 text-white p-4 text-center text-2xl font-bold">
    FST - Fantasy Sport Token
</header>

<main class="p-4 max-w-6xl mx-auto">

<!-- Telegram User Info -->
<section id="telegramUser" class="mb-4 p-3 bg-gray-200 rounded">
    <h2 class="text-lg font-semibold">Hello, <span id="tgName">Guest</span></h2>
    <p id="tgUsername"></p>
</section>

<!-- User Local Time -->
<section id="localTime" class="mb-4 p-2 bg-gray-200 rounded">
    <p>Your local time: <span id="userTime"></span></p>
</section>

<!-- Wallet Section -->
<section id="wallet" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Connect Wallet</h2>
    <button id="connectWallet" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        Connect Wallet
    </button>
    <p id="walletAddress" class="mt-2 text-sm"></p>
</section>

<!-- Top Players Section -->
<section id="players" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Top Players</h2>
    <div id="playersList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</section>

<!-- Search Section -->
<section id="search" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Search Players</h2>
    <input type="text" id="playerSearch" placeholder="Search by name, team, or position..." 
        class="w-full p-2 border rounded shadow mb-2">
    <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</section>

<!-- Favorites Section -->
<section id="favoritesLive" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Favorite Players Live Points</h2>
    <div id="favoritesLiveList" class="space-y-2"></div>
</section>

<!-- Transfers Chart Section -->
<section id="transfers" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Gameweek Transfers</h2>
    <canvas id="transfersChart" class="bg-white p-4 rounded shadow"></canvas>
</section>

<!-- League Table Section -->
<section id="league" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">League Table</h2>
    <div id="leagueTable" class="overflow-x-auto"></div>
</section>

<!-- Leaderboard Section -->
<section id="leaderboard" class="mb-6">
    <h2 class="text-xl font-semibold mb-2">FST Token Leaderboard</h2>
    <div id="leaderboardList" class="overflow-x-auto bg-white p-4 rounded shadow"></div>
</section>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

// Telegram user info
const tgUser = tg.initDataUnsafe?.user;
if(tgUser){
    document.getElementById('tgName').textContent = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
    document.getElementById('tgUsername').textContent = tgUser.username ? '@' + tgUser.username : '';
}

// Auto-detect user local time
function updateLocalTime(){
    const now = new Date();
    const timeStr = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    document.getElementById('userTime').textContent = timeStr;
}
setInterval(updateLocalTime,1000);
updateLocalTime();

// Web3 Wallet
const connectWalletBtn = document.getElementById('connectWallet');
const walletAddressEl = document.getElementById('walletAddress');
connectWalletBtn.addEventListener('click', async () => {
    if(window.ethereum){
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        walletAddressEl.textContent = `Connected: ${accounts[0]}`;
    } else {
        alert('Please install Metamask!');
    }
});

// FPL API base (CORS proxy)
const FPL_BASE = 'https://cors-anywhere.herokuapp.com/https://fantasy.premierleague.com/api';

// Data stores
let allPlayers = [];
let favorites = {}; // keyed by Telegram user id
let fstTokens = {}; // FST tokens per Telegram user
let currentGW = 1;

// Initialize for current user
if(tgUser){
    favorites[tgUser.id] = [];
    fstTokens[tgUser.id] = 0;
}

// Fetch top players
async function fetchPlayers() {
    try {
        const res = await axios.get(`${FPL_BASE}/bootstrap-static/`);
        allPlayers = res.data.elements;
        displayPlayers(allPlayers.slice(0,20));
    } catch(err){ console.error(err); }
}

// Display players
function displayPlayers(players){
    const container = document.getElementById('searchResults');
    container.innerHTML='';
    players.forEach(player=>{
        const card = document.createElement('div');
        card.className='bg-white p-4 rounded shadow hover:shadow-lg transition cursor-pointer';
        card.innerHTML=`
            <h3 class="font-semibold">${player.web_name}</h3>
            <p>Team: ${player.team}</p>
            <p>Position: ${player.element_type}</p>
            <p>Price: £${player.now_cost/10}</p>
            <p>Points: ${player.total_points}</p>
            <button class="addFav bg-yellow-400 px-2 py-1 rounded mt-2">☆ Favorite</button>
            <div class="playerDetails mt-2 hidden"></div>
        `;
        // Player details on click
        card.addEventListener('click', async e=>{
            if(e.target.classList.contains('addFav')) return;
            const detailsDiv = card.querySelector('.playerDetails');
            if(detailsDiv.innerHTML===''){
                const detailRes = await axios.get(`${FPL_BASE}/element-summary/${player.id}/`);
                detailsDiv.innerHTML=`
                    <p>Goals: ${detailRes.data.history.reduce((a,b)=>a+b.goals_scored,0)}</p>
                    <p>Assists: ${detailRes.data.history.reduce((a,b)=>a+b.assists,0)}</p>
                    <p>Minutes Played: ${detailRes.data.history.reduce((a,b)=>a+b.minutes,0)}</p>
                `;
            }
            detailsDiv.classList.toggle('hidden');
        });
        // Favorite button
        const favBtn = card.querySelector('.addFav');
        favBtn.addEventListener('click', e=>{
            e.stopPropagation();
            if(tgUser){
                const userFavs = favorites[tgUser.id];
                if(!userFavs.includes(player.id)){
                    userFavs.push(player.id);
                    favBtn.textContent='★ Favorited';
                    favBtn.classList.add('bg-yellow-600');
                } else {
                    favorites[tgUser.id] = userFavs.filter(id=>id!==player.id);
                    favBtn.textContent='☆ Favorite';
                    favBtn.classList.remove('bg-yellow-600');
                }
                updateFavoritesLive();
            }
        });
        container.appendChild(card);
    });
}

// Search players
document.getElementById('playerSearch').addEventListener('input', e=>{
    const query = e.target.value.toLowerCase();
    const filtered = allPlayers.filter(p=>{
        const team = p.team.toString();
        const pos = p.element_type.toString();
        return p.web_name.toLowerCase().includes(query) || team.includes(query) || pos.includes(query);
    });
    displayPlayers(filtered);
});

// Fetch current GW
async function fetchCurrentGW(){
    try{
        const res = await axios.get(`${FPL_BASE}/events/`);
        currentGW = res.data.current;
    } catch(err){ console.error(err); }
}

// Update live points and FST tokens
async function updateFavoritesLive(){
    try{
        if(!tgUser || favorites[tgUser.id].length===0) return;
        const res = await axios.get(`${FPL_BASE}/event/${currentGW}/live/`);
        const picks = res.data.elements;
        const container = document.getElementById('favoritesLiveList');
        container.innerHTML='';

        favorites[tgUser.id].forEach(favId=>{
            const playerLive = picks.find(p=>p.id===favId);
            if(playerLive){
                const points = playerLive.stats.total_points;
                fstTokens[tgUser.id] += points;

                const div = document.createElement('div');
                div.className='bg-white p-3 rounded shadow';
                div.innerHTML=`
                    <strong>${allPlayers.find(p=>p.id===favId).web_name}</strong>
                    <p>Live Points: ${points}</p>
                    <p>Goals: ${playerLive.stats.goals_scored||0}</p>
                    <p>Assists: ${playerLive.stats.assists||0}</
